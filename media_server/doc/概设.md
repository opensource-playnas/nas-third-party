# 媒体服务播放器部分
## 需求概述
要求能够提供网页端和移动端能够播放Nas上常规格式的视频文件

## 修改历史
  |  版本  |     日期      |  作者  |   备注   |
  | :----: | :-----------: | :----: | :------: |
  | v0.0.1 | 2023年1月16日 | 雷小航 | 创建文档 |
## 模块形式
  * ### 独立进程
## 功能模块
![avatar](img\功能模块.drawio.png)

### 模块说明
#### 媒体信息解析
这部分内容主要是利用ffmpeg sdk 针对媒体文件解析出 相关的转码参数，包括 封装格式、编码、码率、音轨、字幕等信息。
由于 ffmpeg 的sdk 的开源协议时GPLv3，所以将 调用ffmpeg sdk 的部分封装成了一个独立的 进程（ffmpeg_tools.exe）
media.service.exe 通过调用的 ffmpeg_tools.exe 解析指定的媒体文件，并将结果输出到标准输出。
##### 命令行示例
ffmpeg_tools.exe --parse="C:\abc\test.mp4"

- 视频流
  - 索引、编码、封装格式、码率、高宽、实际帧率、平均帧率、画面比例、元数据、时长
- 音频流
  - 索引、编码、码率、通道数、采样率
- 字幕流
  - 索引、编码
- 章节信息
  - 标题、起始时间、结束时间

#### 播放任务
主要是给播放端提供播放任务相关的状态查询，包括当前转码进度、速率、状态等信息。

##### 播放流程图
![avatar](img\流程.drawio.png)


##### 播放页长连接
为了保证播放页面在关闭后，服务端能够及时取消播放任务避免资源浪费，所以采用check 页面长连接的方式来监控播放页的退出
流程如下：
![avatar](img\长连接check.drawio.png)

##### ts 切片文件管理
该模块主要提供播放端在请求 ts切片文件时，保证ts 文件的正确性以及，在跳转进度时，能够根据指定ts文件 对应的时间点重新进行转码，从而达到快速跳转的目录。
流程如下：
![avatar](img\ts_check.drawio.png)

##### 缓存管理
该模块主要管理播放任务转码的输出缓存文件，包括 m3u8文件、ts文件、ffmpeg 输出内容等，以播放任务id 为目录名称。在播放任务被取消后，会删除该目录
- 输出路径： .home_nas/video_server/transcode/%task_id%


#### 转码管理
1、根据当前硬件信息选择当前转码加速方式
2、根据具体的媒体信息，使用ffmpeg 进行hls 格式的转码部分，并且需要实时获取转码的相关信息。

##### 转码参数
1、该模块主要根据视频文件解析出的信息构造转码参数
- 具体参数说明请参考: 转码参数.md
  
2、转码时可根据当前的硬件环境选择转码时 采用硬件加速，在进程启动时会先先通过ffmpeg 命令行测试是否可通过硬件加速来进行转码。
- NVIDIA: ffmpeg -f lavfi -i testsrc=duration=10:size=1280x720:rate=30 -c:v h264_nvenc -preset fast -b:v 2M -f null NUL
- intel: ffmpeg -f lavfi -i testsrc=duration=10:size=1280x720:rate=30 -c:v h264_qsv -preset fast -b:v 2M -f null NUL

3、上面的ffmpeg 命令行主要是先生成一段时长 为 10s，分辨率为 1280*720 的视频，然后通过硬件加速的方式转码到h264编码格式，最后丢弃转码的输出。以此来测试是否支持硬件加速转码。

4、在转码参数中，有一个切片长度的参数。该参数主要根据 源视频的编码和封装格式有关
- h264 编码的 mkv 格式视频，需要先通过 第三方库（matroska、ebml）来提取 关键帧序列， 从而根据该序列生成 m3u8的文件中的列表时长序列
- 其他视频则采用 切片时间等长的方式进行转码。
  
5、字幕提取统一采用 vtt格式
- 输出路径：.home_nas/video_server/subtitles/%media_id%_%index%.vtt
- 命令行：ffmpeg -hide_banner -i 视频文件路径 -map 0:2 -v error -an -vn -c:s webvtt -y "输出路径"

##### 转码任务
该模块主要根据转码参数，调用ffmpeg 进程启动一个转码任务。并持续针对ffmpeg 的标准输出，计算其转码的速率以及进度。
当采用硬件加速转码失败后，会尝试通过软编解码的方式进行重试转码。
