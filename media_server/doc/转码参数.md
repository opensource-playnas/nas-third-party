
# 转码
通过ffmpeg进行转码主要涉及到几个参数
- 开始时间
- 输入格式
- 解码器
- 输入文件
- 视频编码器
- 视频编码选项
  - gop 长度
  - 预设值
  - 画质平衡
  - 码率
  - 强制关键帧时间
- 视频过滤器
- 音频编码器
- 音频编码选项
- hls相关参数
  
##  开始时间
该参数是设置从源视频的哪个时间点开始转码。
默认不带该参数，即从视频最开始的关键帧位置开始转码。
当播放时，需要seek到指定位置时，可以通过该参数来快速定位到需要seek的时间点进行转码。这样就能实现快速seek的目的
## 输入格式
指定需要转码的源视频的封装格式，可以不指定该参数，ffmpeg会自动识别。但是参考Jellyfin项目，是将该参数指定了的，后面通过查阅资料，发现手动指定输入视频的封装格式可以提高视频解码速度(虽然不是很明显)。
## 解码器
该参数是指定解码源视频时采用的解码器名称，主要是在使用硬件解码时需要指定，如果不需要的话，可以不用指定该参数，由ffmpeg自动识别。
当需要用硬件进行解码是，该参数的值一般根据不同显卡指定不同的值，
- DXVA2 
    该加速方式可以支持Intel AMD NVIDIA 三种显卡的硬件解码，指定了该值时，当硬件不支持当前视频的编码方式，或者显卡不支持，都会自动降为纯软解码。
- Qsv 
    该方式是Intel的专有硬件加速方式。当显卡为Intel时，可以指定该解码方式，Qsv只是硬件加速的名称，并不是编码器，如果要使用该加速方式，需要手动指定源视频的编码方式所对应的Qsv解码器。
    例如：当源视频的编码为h264时，则指定该值为 h264_qsv;当源视频编码是h265时，需要指定位 hevc_qsv,除了这两种以外，还支持 av1_qsv，目前仅支持这三种编码方式的硬件加速。
- Cuda
    Cuda是NVIDIA 的专有硬件解码器，在指定该值前需要通过ffmpeg 测试当前环境是否支持Cuda的硬件加速。该方式不用不用指定源视频的编码，其内部会自动识别。
## 输入文件
指定需要转码的视频文件的路径即可

## 视频编码器
编码器指定是需要将视频转码的目标编码格式。
由于我们转码后的ts片段需要支持在web端进行播放，所以需要将视频转转码为 h264 的编码格式。目前支持h264编码的编码器有以下几种：
- libx264
    libx264是最常用的一种h264编码器，具体编解码方式就不在这里讨论了，只需要知道该编码方式仅支持软编解码。
- h264_qsv
    该编码器同上面介绍的 h264_qsv解码器一样，当编码器采用h264_qsv，ffmpeg在转码时，会利用Intel的GPU进行编码，这样能够大幅提升转码效率。同样，在指定该值时需要先通过ffmepg的sdk判断当前环境是否支持Qsv的硬件加速方式。
- h264_amf
    h264_amf是AMD的专有硬件编码加速方式，当显卡是AMD时，可以指定该值。需要注意的是，不是所有的AMD显卡都支持。
- h264_nvenc
    h264_nvenc 是NVIDIA显卡专有的h264编码硬件加速的编码器，当显卡是NVIDIA时，可以指定该值。   

这里需要注意的是，如果源视频的编码已经是h264了，并且其封装格式是mkv，则不需要重新编码，其编码器指定为 copy 即可，这样就少了转码的步骤，直接重新转封装格式为ts即可，速度就会很快。
mkv 格式的文件由于是通过ebml的标记语言格式组成的，所以可以通过ebml的格式，来获取到里面关键帧时间点的序列，这样就能提前根据其关键帧时间序列生成hls的m3u8索引，同时编码是h264的，又不需要重新转码，这样就大幅提高视频切片的效率。
这里读取mkv文件内容的第三方库，可以参考： matroska;这个库又依赖 ebml 库。目前已经将这两个库集成到我们的项目代码中。
## 视频编码选项
如果编码器指定的 copy 值的话，那就不需要指定编码选项了。
视频编码选项主要涉及下面几个选项
- gop 长度
    该参数主要是设置关键帧的间隔。
    将该值固定为23，意思为每23帧，会有一个关键帧，这是因为在测试过程中发现，一旦用硬件加速进行转码的话，会出现ts切的时长和数量会和纯软件转码切出的ts表现不一致，后面通过测试发现，可以使用该参数可以解决这个问题。
-  预设值(preset)
    这个参数主要调节编码速度和质量的平衡，有ultrafast、superfast、veryfast、faster、fast、medium、slow、slower、veryslow、placebo这10个选项，从快到慢。通过参考 Jellyfin ，将该值固定为 veryfast。
-  画质平衡(crf)
    固定码率因子（CRF）是 x264 和 x265 编码器的默认质量（和码率控制）设置。取值范围是 0 到 51，这其中越低的值，结果质量越好，同时输出文件越大，越高的值意味着越高的压缩比，但你可能会在值大到某个点的时候注意到明显的质量损失。对 h264，一般取值在 18 到 28 之间，通过参考 Jellyfin ，将该值固定为 23
- 码率(maxrate)
    该参数主要是控制视频的转码时的目标码率，一般不固定某一个码率，通过设置最大码率限制参数来控制即可，这样可有效提升转码效率，以及传输效率。ffmpeg官方wiki比较建议，设置码率时，同时加上 -bufsize ，-bufsize 用于设置码率控制缓冲器的大小，设置的好处是，让整体的码率更趋近于希望的值，减少波动。通过参考 Jellyfin ，将maxrate的值根据视频源码率做了一个最优的计算，同时设置bufsize的值为maxrate值的两倍。
- 强制关键帧时(force_key_frames)
    主要是针对在转码前无法提取关键帧时间点序列的视频，通过该参数可以强制指定关键帧的间隔，比如要将视频切成3秒为一个ts片段的序列，则指定该参数 为 expr:gte(t,0+n_forced*3)，意思是，每个3秒插入一个关键帧，这样就能保证每个ts片段都有一个关键帧。这里需要注意，如果是seek到其他时间点的话，表达式中的0要修改成需要seek到的时间点，比如seek到 第10秒开始转码，那这时候的表达式则为 expr:gte(t,10+n_forced *3)。
## 视频过滤器(vf)
视频过滤器可以有多个，当指定多个时，用逗号分隔。目前主要涉及以下两个：
- scale
  该值指定视频转码后的分辨率缩放规则，一般可包含固定尺寸以及最大尺寸的设置，并且支持表达式，例如：scale=trunc(min(max(iw\,ih* a)\,min(1920\,1080* a))/2)* 2:trunc(min(max(iw/a\,ih)\,min(1920/a\,1080))/2)*2
- format
  该值主要指定图像流的像素格式，将该值固定为: yuv420p即可。
  
## 音频编码器
由于前端需要在线播放，部分音频格式是不能直接在网页播放的，所以需要将音频编码转换为 aac，如果源视频的音频编码已经是aac了，则可以指定 copy， 避免重新转。
## 音频编码选项
如果源视频音频需要转码为aac 的话，则需要指定编码选项，主要涉及以下几个选项：
- 通道数(ac)
    2，主要参考Jellyfin
- 码率(ab)
    根据源视频的音频码率计算出最优码率，并设置。主要参考Jellyfin
- 采样频率(ar)
    48000，主要参考Jellyfin
## 音频过滤器(af)
该参数只有在需要音频转码时才设置,只涉及到一个过滤，那就是音量。
- volume
    2，默认值

## hls相关参数
hls是转码的输出格式，其相关参数包括如下几个：
- copyts
   该参数没有值，根据官方的解释：不要处理输入时间戳，而是保留它们的值而不尝试清理它们。特别是，不要删除初始开始时间偏移值。通过测试发现，该值会影响最终生成的ts文件的时长。
- avoid_negative_ts
  该参数的值有：make_non_negative、make_zero、auto 、disabled, 当启用该参数时，即会将视频时间扩展到关键帧，但是裁剪的时间不准确。为了避免这种情况，所以需要手动设置为 disabled。
- hls_time
  该参数是指定ts片段的时长。注意，该值和上面强制指定关键帧后面的 表达式有关系。
- start_number
  指定转换格式后，第一个ts 的序号，默认都是从0开始，当重新seek后，需要计算当前seek到的时间点位于哪一个ts，然后将对应的ts 序号作为该参数的值。
- hls_segment_filename 
    指定ts切片的文件名称,由于有序列的区别，可以采用格式化字符，比如: slice-%05d.ts。
- hls_playlist_type
    指定m3u8索引的类型，这里有event(直播)、vod(点播)。
    由于我们会在转码前自己根据关键帧时间序列自己生成m3u8索引，如果是非h264编码mkv格式的视频，我们则会以等时长的方式进行切片，那生成的m3u8索引就是等时长的。
    由于提前生成了完整的m3u8索引，所以这里取值为 vod。这样播放端就能够提前计算出媒体文件的时长以及知道seek时，能够对应到正确的ts文件。
- hls_list_size
    指的生成的索引文件中，默认保留多少条ts记录，如果该值为非0 ，则在生成的过程中，会始终只保持有固定数量的ts 文件，如果超过该数量，则会依次删除序号最小的ts文件，由于我们这里需要保存所有生成的ts文件，所以，这里的值必须设置为 0
- y
    表示强制覆盖同名文件，这个参数主要涉及到，在播放视频时，来回seek，导致上一次的转码任务还未完成时，这次seek到新的时间点，就会强制结束上一个任务，导致正在生成ts文件处于未完成状态，当新的转码任务，转到该ts文件时，就可以覆盖之前为完成的ts，从而保证ts文件的有序和完整。
