# dlna.service 设计文档

## 修改历史
  | 版本 | 日期 | 作者 | 备注 |
  | -- | -- | -- | -- | 
  | v0.0.1 | 2023年12月28日 | 雷小航 | 创建文档 |

----------------
## 1 引言

### 1.1 背景、编写目的
- 背景
  1. NAS用户可以通过访问端在私有云端局域网所在的投屏设备上对视频文件进行投屏播放  
  针对以上背景需求私有云需要对访问端提供必要的业务支撑。
- 编写目的  
1. 结合对产品需求的梳理以及目前选型的技术方向，转换为软件开发设计文档。
2. 描述清楚编码前的整体思路，便于编码前对设计的评审，预防潜在的风险。
3. 便于对后期代码的维护和拓展。
- 读者对象：相关开发人员、项目管理人员、研发leader。 

### 1.2 术语、名词解释
  | 缩写、术语 | 解释 |
  | -- | -- |
  |  |  |

----------------
## 2 概述
### 2.1 服务的任务
#### 2.1.1 目标
1. 为访问端提供投屏相关的操作，包括发现投屏设备、投屏、更新投屏视频的播放状态等。
2. 保证程序的稳定性和良好的性能，代码易读易扩展。

#### 2.1.2 运行环境
&nbsp;&nbsp;&nbsp;&nbsp;跨平台，Windows(X86_64/ARM64)、Ubuntu(X86_64/ARM64)。

#### 2.1.3 与其他程序关系
  | 依赖的程序 | 依赖原因 |
  | -- | -- |
  | message.service.exe | 将投屏设备的视频播放状态通过该模块通知给前端 |
  | redis.exe | 通过该模块查询投屏页面的长连接状态 |

#### 2.1.4 使用的第三方开源库
| 名称 | 主要功能 | 开源地址 |
  | -- | -- | -- |
  | platinum | 模块化 UPnP 框架  | https://github.com/plutinosoft/Platinum |
  | neptune | C++ 基础工具库, platinum 的依赖库 |https://github.com/plutinosoft/Neptune|

### 2.2 需求规定
- 输入/输出：接受GRPC接口请求返回相应的结果。
- 性能要求：
1. 作为服务端，必须重视程序运行稳定性和性能。


#### 2.2.1 功能需求
- 探测私有云端所在局域网中所有可以投屏的设备，并提供给访问端进行查询
- 提供访问端将指定的播放链接投屏到 指定的设备上进行播放
- 提供访问端与投屏设备的交互，包括进度跳转、改变音量、暂停、播放、取消等操作
- 同步投屏设备的播放状态到访问端，包括播放进度、播放状态、音量等
#### 2.2.2 参考文档
- 投屏协议
  DLNA（Digital Living Network Alliance），即数字家庭网络联盟。
参考文档：
https://www.jianshu.com/p/91b508b0260b
https://breezetemple.github.io/2019/02/25/dlan-introduction/
https://www.jianshu.com/p/fbc7c700cdb5
  
----------------
## 3 总体设计  

### 3.1 系统结构  

#### 3.1.1 投屏流程
所有和投屏设备交互相关的操作都通过调用 Platinum 库的提供的 SDK 实现
![avatar](img\流程.drawio.png)

#### 3.1.2 功能模块
![avatar](img\功能模块.drawio.png)
- 投屏设备交互
  该模块是由 Platinum 库提供的sdk 组成。主要包括以下几个功能
  1、局域网投屏设备的探测以及 根据DLNA 协议解析投屏设备提供的服务及相关接口
  2、根据DLNA协议调用 设备的投屏、音量增减、进度跳转、查询播放状态等交互接口
- 投屏任务
  该模块主要定时推送 投屏设备的播放状态。包括：进度、音量、状态等信息，具体数据结构参考 ApiFox 
- 任务管理
  该模块主要管理局域网中的投屏设备的在线与下线，以及定时查询访问端投屏页面的长连接状态，当长连接断开后，会停止推送该投屏任务的状态同步并取消任务，但是这里不会取消投屏,除非访问端手动点击取消投屏（产品要求）。
### 3.2 接口设计
参考 apifox 中 私有云/媒体服务/投屏 : https://app.apifox.com/project/2811563